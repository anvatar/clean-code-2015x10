# 9장. 단위 테스트

테스트를 추가하려고 급하게 서두르는 와중에 많은 프로그래머들이 제대로 된 테스트 케이스를 작성해야 한다는 좀 더 미묘한 (그리고 더욱 중요한) 사실을 놓쳐버렸다.

## TDD 법칙 세 가지

실제 코드를 짜기 전에 단위 테스트부터 짜라는 규칙은 빙산의 일각에 불과하다.

세 가지 법칙

1. 실패하는 단위 테스트를 작성할 때까지 실제 코드를 작성하지 않는다.
1. 컴파일은 실패하지 않으면서 실행이 실패하는 정도로만 단위 테스트를 작성한다.
1. 현재 실패하는 테스트를 통과할 정도로만 실제 코드를 작성한다.

효과

- 개발과 테스트가 대략 30초 주기로 묶인다.
- 테스트 코드가 실제 코드보다 불과 몇 초 전에 나온다.
- 방대한 테스트 코드가 나온다.
    - 매일 수십 개에 달하는 테스트 케이스
    - 실제 코드를 사실상 전부 테스트하는 테스트 케이스

실제 코드와 맞먹을 정도로 방대한 테스트 코드는 심각한 관리 문제를 유발하기도 한다.

## 깨끗한 테스트 코드 유지하기

지저분한 테스트 코드는 없는 것보다 못하다.

- 실제 코드가 진화하면 테스트 코드도 변해야 한다.
- 테스트 코드가 지저분할 수록 변경하기 어려워지고 부담이 계속 늘어난다.
- 개발팀에서 테스트 코드가 비난의 대상이 되고, 결국 테스트 코드를 폐기하게 된다.
- 코드는 망가지고, 테스트에 대한 실망감만 남는다.

테스트 코드는 실제 코드 못지 않게 중요하다.

- 실제 코드 못지 않게 깨끗하게 짜야 한다.
- 테스트는 유연성, 유지보수성, 재사용성을 제공한다.
    - 테스트 케이스가 있으면 안심하고 아키텍처와 설계를 개선할 수 있다.

## 깨끗한 테스트 코드

테스트 코드의 가독성을 높이는 규칙은 실제 코드와 마찬가지다. 명료성, 단순성, 풍부한 표현력.

FitNess 예제

- 리팩터링 전
    - 중복되는 코드가 매우 많고 자질구레한 사항이 너무 많아 테스트 코드의 표현력이 떨어진다.
    - 온갖 잡다하고 무관한 코드를 이해한 후라야 간신히 테스트 코드를 이해할 수 있다.
- 리팩터링 후
    - BUILD-OPERATE-CHECK 패턴의 명확한 테스트 구조
    - 중복 제거, 메서드 추출 => 잡다하고 세세한 코드를 거의 다 없앴다.
        - 진짜 필요한 자료 유형과 함수만 사용
        - 코드가 수행하는 기능을 재빨리 이해

도메인에 특화된 테스트 언어

- 잡다하고 세세한 사항으로 범벅된 코드를 계속 리팩터링하다가 진화된 API
- 더 간결하고 표현력이 풍부한 코드

이중 표준

- 테스트 코드는 실제 코드만큼 깨끗해야 하지만, 그만큼 효율적일 필요는 없다.
- 가독성을 높이기 위해 특정 규칙을 변형하여 적용하기도 하지만, 코드의 깨끗함을 유지하도록 한다.

## 테스트 당 assert 하나?

'단일 assert 문'은 훌륭한 지침이다.

- 결론이 하나라서 코드를 이해하기 쉽고 빠르다.
- given-when-then 관례를 사용하면 테스트 코드 읽기가 쉬워진다.

테스트를 지나치게 분리하면 중복된 코드가 많아지는 경향이 있다. 중복을 제거할 수 있는 기술적인 방법은 존재하지만, 보통 배보다 배꼽이 큰 격이다.

assert 문 개수를 최대한 줄이는 방향으로 노력한다.

테스트 당 개념 하나

- 독자적인 개념 여러 개를 하나의 테스트 함수에 몰아넣으면 독자가 각 절이 거기에 존재하는 이유와 각 절이 테스트하는 개념을 모두 이해해야 한다.

가장 좋은 규칙

- 개념 당 assert 문 수를 최소로 줄여라.
- 테스트 함수 하나는 개념 하나만 테스트하라.

## F.I.R.S.T

깨끗한 테스트의 다섯 가지 규칙

- **F**ast (빠르게)
    - 테스트가 느리면 자주 돌릴 엄두를 못 내고, 초반에 문제를 찾아내 고치지 못한다.
- **I**ndependent (독립적으로)
    - 테스트가 서로에게 의존하면 하나가 실패할 때 나머지도 잇달아 실패하므로 원인을 진단하기 어려워지며 후반 테스트가 찾아내야 할 결함이 숨겨진다.
- **R**epeatable (반복가능하게)
    - 어떤 상황에서도 반복 가능해야 한다.
- **S**elf-validating (자가검증하는)
- **T**imely (적시에)
    - 테스트하려는 실제 코드를 구현하기 직전에 구현한다.

